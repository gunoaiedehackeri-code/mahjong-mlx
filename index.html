<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mahjong MLX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        .tile-3d { position: absolute; transition: all 0.3s; cursor: pointer; user-select: none; }
        .tile-3d:hover:not(.matched):not(.blocked) { transform: translateY(-5px); filter: brightness(1.1); }
        .tile-face {
            background: linear-gradient(145deg, #ffffff, #f5f5f5);
            border: 2px solid #8b7355;
            border-radius: 6px;
            box-shadow: 2px 2px 6px rgba(0,0,0,0.3), inset 1px 1px 2px rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tile-selected { background: linear-gradient(145deg, #fef3c7, #fde68a) !important; transform: translateY(-3px) scale(1.03); }
        .tile-blocked { opacity: 0.5; cursor: not-allowed; }
        .tile-matched { opacity: 0; pointer-events: none; }
        .tile-removal-mode { border: 3px solid #ef4444 !important; animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 10px #ef4444; } 50% { box-shadow: 0 0 20px #ef4444; } }
        .tile-will-remove { background: linear-gradient(145deg, #fca5a5, #ef4444) !important; border-color: #dc2626 !important; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const MahjongMLX = () => {
            const [gameState, setGameState] = useState('login');
            const [user, setUser] = useState(null);
            const [level, setLevel] = useState(1);
            const [mmlxBalance, setMmlxBalance] = useState(0);
            const [tiles, setTiles] = useState([]);
            const [selectedTiles, setSelectedTiles] = useState([]);
            const [startTime, setStartTime] = useState(null);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [averageTime, setAverageTime] = useState(180);
            const [completedLevels, setCompletedLevels] = useState(0);
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [isLogin, setIsLogin] = useState(true);
            const [exchangeRate, setExchangeRate] = useState(100000);
            const [isAdmin, setIsAdmin] = useState(false);
            const [hint, setHint] = useState('');
            
            const [showAd, setShowAd] = useState(false);
            const [adPurpose, setAdPurpose] = useState('');
            const [isRemovalMode, setIsRemovalMode] = useState(false);
            const [removalPreview, setRemovalPreview] = useState([]);
            const [adRemovalsUsed, setAdRemovalsUsed] = useState(0);
            const [adRemovalCooldown, setAdRemovalCooldown] = useState(0);
            const [maxAdRemovalsPerLevel, setMaxAdRemovalsPerLevel] = useState(2);
            const [adFrequency, setAdFrequency] = useState(3);
            const [adsEnabled, setAdsEnabled] = useState(true);
            const [adCountdown, setAdCountdown] = useState(5);
            const [adForCoinsUsed, setAdForCoinsUsed] = useState(false);
            const [mmlxPerAd, setMmlxPerAd] = useState(500);
            const [mlxAddress, setMlxAddress] = useState('');
            const [tangledUsername, setTangledUsername] = useState('');
            const [showTangledPrompt, setShowTangledPrompt] = useState(false);
            
            // EmailJS Configuration
            const EMAILJS_SERVICE_ID = 'service_pta9wmt';
            const EMAILJS_TEMPLATE_ID = 'template_iqxpxuk';
            const EMAILJS_PUBLIC_KEY = 'pWixVv62QrlwjPZAm';

            const ADMIN_USERNAME = 'admin';
            const ADMIN_PASSWORD_HASH = 'TXlTZWN1cmVQYXNzd29yZDIwMjUh';
            
            // Security: Generate checksum for user data
            const generateChecksum = (data) => {
                const str = JSON.stringify(data);
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString(36);
            };
            
            // Security: Verify data hasn't been tampered with
            const verifyUserData = (username) => {
                const users = JSON.parse(localStorage.getItem('mahjongUsers') || '{}');
                const user = users[username];
                if (!user) return true;
                
                const expectedChecksum = generateChecksum({
                    password: user.password,
                    mmlxBalance: user.mmlxBalance,
                    level: user.level,
                    completedLevels: user.completedLevels
                });
                
                if (user.checksum && user.checksum !== expectedChecksum) {
                    alert('âš ï¸ Data integrity error detected. Account suspended. Contact admin.');
                    localStorage.removeItem('mahjongUsers');
                    window.location.reload();
                    return false;
                }
                return true;
            };
            
            // Security: Save user data with checksum
            const saveUserData = (username, userData) => {
                const users = JSON.parse(localStorage.getItem('mahjongUsers') || '{}');
                const checksum = generateChecksum({
                    password: userData.password,
                    mmlxBalance: userData.mmlxBalance,
                    level: userData.level,
                    completedLevels: userData.completedLevels
                });
                users[username] = { ...userData, checksum, lastUpdate: Date.now() };
                localStorage.setItem('mahjongUsers', JSON.stringify(users));
            };
            
            // Security: Check if user can exchange (max 1 per 24 hours)
            const canUserExchange = (username) => {
                const exchanges = JSON.parse(localStorage.getItem('exchangeRequests') || '[]');
                const userExchanges = exchanges.filter(ex => ex.username === username);
                
                if (userExchanges.length === 0) return { allowed: true };
                
                const lastExchange = userExchanges[userExchanges.length - 1];
                const lastExchangeTime = new Date(lastExchange.timestamp).getTime();
                const hoursSinceLastExchange = (Date.now() - lastExchangeTime) / (1000 * 60 * 60);
                
                if (hoursSinceLastExchange < 24) {
                    const hoursRemaining = Math.ceil(24 - hoursSinceLastExchange);
                    return { 
                        allowed: false, 
                        hoursRemaining 
                    };
                }
                
                return { allowed: true };
            };

            const getTileSets = (lvl) => {
                const basic = ['ðŸ€„', 'ðŸŽ‹', 'ðŸŽ', 'ðŸŒ¸', 'ðŸŒº', 'ðŸŒ»', 'ðŸŒ¼', 'ðŸŒ·'];
                if (lvl >= 15) return [...basic, ...['ðŸµï¸', 'ðŸŒ¹', 'ðŸ¥€', 'ðŸª·']];
                return basic;
            };

            const getLayout = (lvl) => {
                // Progressive difficulty: More tiles and layers as level increases
                
                if (lvl === 1) {
                    // Tutorial level - 12 tiles, 2 layers
                    return [
                        {x:1,y:1,z:0},{x:2,y:1,z:0},{x:3,y:1,z:0},{x:4,y:1,z:0},
                        {x:1,y:2,z:0},{x:2,y:2,z:0},{x:3,y:2,z:0},{x:4,y:2,z:0},
                        {x:2,y:1,z:1},{x:3,y:1,z:1},{x:2,y:2,z:1},{x:3,y:2,z:1}
                    ];
                }
                
                if (lvl >= 2 && lvl <= 4) {
                    // Easy - 18-24 tiles, 2 layers
                    const base = [
                        {x:2,y:1,z:0},{x:3,y:1,z:0},{x:4,y:1,z:0},{x:5,y:1,z:0},
                        {x:1,y:2,z:0},{x:2,y:2,z:0},{x:3,y:2,z:0},{x:4,y:2,z:0},{x:5,y:2,z:0},{x:6,y:2,z:0},
                        {x:2,y:3,z:0},{x:3,y:3,z:0},{x:4,y:3,z:0},{x:5,y:3,z:0},
                        {x:3,y:1,z:1},{x:4,y:1,z:1},{x:3,y:2,z:1},{x:4,y:2,z:1}
                    ];
                    // Add more tiles for higher levels in this range
                    if (lvl >= 3) base.push({x:2,y:2,z:1},{x:5,y:2,z:1});
                    if (lvl >= 4) base.push({x:3,y:3,z:1},{x:4,y:3,z:1});
                    return base;
                }
                
                if (lvl >= 5 && lvl <= 10) {
                    // Medium - 36-52 tiles, 3 layers
                    return [
                        // Layer 0 - Foundation
                        {x:2,y:0,z:0},{x:3,y:0,z:0},{x:4,y:0,z:0},{x:5,y:0,z:0},{x:6,y:0,z:0},
                        {x:1,y:1,z:0},{x:2,y:1,z:0},{x:3,y:1,z:0},{x:4,y:1,z:0},{x:5,y:1,z:0},{x:6,y:1,z:0},{x:7,y:1,z:0},
                        {x:0,y:2,z:0},{x:1,y:2,z:0},{x:2,y:2,z:0},{x:3,y:2,z:0},{x:4,y:2,z:0},{x:5,y:2,z:0},{x:6,y:2,z:0},{x:7,y:2,z:0},{x:8,y:2,z:0},
                        {x:1,y:3,z:0},{x:2,y:3,z:0},{x:3,y:3,z:0},{x:4,y:3,z:0},{x:5,y:3,z:0},{x:6,y:3,z:0},{x:7,y:3,z:0},
                        {x:2,y:4,z:0},{x:3,y:4,z:0},{x:4,y:4,z:0},{x:5,y:4,z:0},{x:6,y:4,z:0},
                        // Layer 1 - Middle
                        {x:2,y:1,z:1},{x:3,y:1,z:1},{x:4,y:1,z:1},{x:5,y:1,z:1},{x:6,y:1,z:1},
                        {x:2,y:2,z:1},{x:3,y:2,z:1},{x:4,y:2,z:1},{x:5,y:2,z:1},{x:6,y:2,z:1},
                        {x:2,y:3,z:1},{x:3,y:3,z:1},{x:4,y:3,z:1},{x:5,y:3,z:1},{x:6,y:3,z:1},
                        // Layer 2 - Top
                        {x:3,y:2,z:2},{x:4,y:2,z:2},{x:5,y:2,z:2}
                    ];
                }
                
                if (lvl >= 11 && lvl <= 20) {
                    // Hard - 68-84 tiles, 4 layers - Full Turtle
                    return [
                        // Layer 0 - Base
                        {x:3,y:0,z:0},{x:4,y:0,z:0},{x:5,y:0,z:0},{x:6,y:0,z:0},{x:7,y:0,z:0},
                        {x:2,y:1,z:0},{x:3,y:1,z:0},{x:4,y:1,z:0},{x:5,y:1,z:0},{x:6,y:1,z:0},{x:7,y:1,z:0},{x:8,y:1,z:0},
                        {x:1,y:2,z:0},{x:2,y:2,z:0},{x:3,y:2,z:0},{x:4,y:2,z:0},{x:5,y:2,z:0},{x:6,y:2,z:0},{x:7,y:2,z:0},{x:8,y:2,z:0},{x:9,y:2,z:0},
                        {x:1,y:3,z:0},{x:2,y:3,z:0},{x:3,y:3,z:0},{x:4,y:3,z:0},{x:5,y:3,z:0},{x:6,y:3,z:0},{x:7,y:3,z:0},{x:8,y:3,z:0},{x:9,y:3,z:0},
                        {x:2,y:4,z:0},{x:3,y:4,z:0},{x:4,y:4,z:0},{x:5,y:4,z:0},{x:6,y:4,z:0},{x:7,y:4,z:0},{x:8,y:4,z:0},
                        {x:3,y:5,z:0},{x:4,y:5,z:0},{x:5,y:5,z:0},{x:6,y:5,z:0},{x:7,y:5,z:0},
                        // Layer 1
                        {x:3,y:1,z:1},{x:4,y:1,z:1},{x:5,y:1,z:1},{x:6,y:1,z:1},{x:7,y:1,z:1},
                        {x:2,y:2,z:1},{x:3,y:2,z:1},{x:4,y:2,z:1},{x:5,y:2,z:1},{x:6,y:2,z:1},{x:7,y:2,z:1},{x:8,y:2,z:1},
                        {x:2,y:3,z:1},{x:3,y:3,z:1},{x:4,y:3,z:1},{x:5,y:3,z:1},{x:6,y:3,z:1},{x:7,y:3,z:1},{x:8,y:3,z:1},
                        {x:3,y:4,z:1},{x:4,y:4,z:1},{x:5,y:4,z:1},{x:6,y:4,z:1},{x:7,y:4,z:1},
                        // Layer 2
                        {x:4,y:1,z:2},{x:5,y:1,z:2},{x:6,y:1,z:2},
                        {x:3,y:2,z:2},{x:4,y:2,z:2},{x:5,y:2,z:2},{x:6,y:2,z:2},{x:7,y:2,z:2},
                        {x:3,y:3,z:2},{x:4,y:3,z:2},{x:5,y:3,z:2},{x:6,y:3,z:2},{x:7,y:3,z:2},
                        {x:4,y:4,z:2},{x:5,y:4,z:2},{x:6,y:4,z:2},
                        // Layer 3 - Peak
                        {x:4,y:2,z:3},{x:5,y:2,z:3},{x:6,y:2,z:3},
                        {x:4,y:3,z:3},{x:5,y:3,z:3},{x:6,y:3,z:3}
                    ];
                }
                
                // Expert - Level 21+ : 100+ tiles, 5 layers - Massive Pyramid
                return [
                    // Layer 0 - Huge base
                    {x:4,y:0,z:0},{x:5,y:0,z:0},{x:6,y:0,z:0},{x:7,y:0,z:0},{x:8,y:0,z:0},{x:9,y:0,z:0},
                    {x:3,y:1,z:0},{x:4,y:1,z:0},{x:5,y:1,z:0},{x:6,y:1,z:0},{x:7,y:1,z:0},{x:8,y:1,z:0},{x:9,y:1,z:0},{x:10,y:1,z:0},
                    {x:2,y:2,z:0},{x:3,y:2,z:0},{x:4,y:2,z:0},{x:5,y:2,z:0},{x:6,y:2,z:0},{x:7,y:2,z:0},{x:8,y:2,z:0},{x:9,y:2,z:0},{x:10,y:2,z:0},{x:11,y:2,z:0},
                    {x:1,y:3,z:0},{x:2,y:3,z:0},{x:3,y:3,z:0},{x:4,y:3,z:0},{x:5,y:3,z:0},{x:6,y:3,z:0},{x:7,y:3,z:0},{x:8,y:3,z:0},{x:9,y:3,z:0},{x:10,y:3,z:0},{x:11,y:3,z:0},{x:12,y:3,z:0},
                    {x:1,y:4,z:0},{x:2,y:4,z:0},{x:3,y:4,z:0},{x:4,y:4,z:0},{x:5,y:4,z:0},{x:6,y:4,z:0},{x:7,y:4,z:0},{x:8,y:4,z:0},{x:9,y:4,z:0},{x:10,y:4,z:0},{x:11,y:4,z:0},{x:12,y:4,z:0},
                    {x:2,y:5,z:0},{x:3,y:5,z:0},{x:4,y:5,z:0},{x:5,y:5,z:0},{x:6,y:5,z:0},{x:7,y:5,z:0},{x:8,y:5,z:0},{x:9,y:5,z:0},{x:10,y:5,z:0},{x:11,y:5,z:0},
                    {x:3,y:6,z:0},{x:4,y:6,z:0},{x:5,y:6,z:0},{x:6,y:6,z:0},{x:7,y:6,z:0},{x:8,y:6,z:0},{x:9,y:6,z:0},{x:10,y:6,z:0},
                    // Layer 1
                    {x:4,y:1,z:1},{x:5,y:1,z:1},{x:6,y:1,z:1},{x:7,y:1,z:1},{x:8,y:1,z:1},{x:9,y:1,z:1},
                    {x:3,y:2,z:1},{x:4,y:2,z:1},{x:5,y:2,z:1},{x:6,y:2,z:1},{x:7,y:2,z:1},{x:8,y:2,z:1},{x:9,y:2,z:1},{x:10,y:2,z:1},
                    {x:2,y:3,z:1},{x:3,y:3,z:1},{x:4,y:3,z:1},{x:5,y:3,z:1},{x:6,y:3,z:1},{x:7,y:3,z:1},{x:8,y:3,z:1},{x:9,y:3,z:1},{x:10,y:3,z:1},{x:11,y:3,z:1},
                    {x:2,y:4,z:1},{x:3,y:4,z:1},{x:4,y:4,z:1},{x:5,y:4,z:1},{x:6,y:4,z:1},{x:7,y:4,z:1},{x:8,y:4,z:1},{x:9,y:4,z:1},{x:10,y:4,z:1},{x:11,y:4,z:1},
                    {x:3,y:5,z:1},{x:4,y:5,z:1},{x:5,y:5,z:1},{x:6,y:5,z:1},{x:7,y:5,z:1},{x:8,y:5,z:1},{x:9,y:5,z:1},{x:10,y:5,z:1},
                    // Layer 2
                    {x:4,y:2,z:2},{x:5,y:2,z:2},{x:6,y:2,z:2},{x:7,y:2,z:2},{x:8,y:2,z:2},{x:9,y:2,z:2},
                    {x:3,y:3,z:2},{x:4,y:3,z:2},{x:5,y:3,z:2},{x:6,y:3,z:2},{x:7,y:3,z:2},{x:8,y:3,z:2},{x:9,y:3,z:2},{x:10,y:3,z:2},
                    {x:3,y:4,z:2},{x:4,y:4,z:2},{x:5,y:4,z:2},{x:6,y:4,z:2},{x:7,y:4,z:2},{x:8,y:4,z:2},{x:9,y:4,z:2},{x:10,y:4,z:2},
                    {x:4,y:5,z:2},{x:5,y:5,z:2},{x:6,y:5,z:2},{x:7,y:5,z:2},{x:8,y:5,z:2},{x:9,y:5,z:2},
                    // Layer 3
                    {x:5,y:2,z:3},{x:6,y:2,z:3},{x:7,y:2,z:3},{x:8,y:2,z:3},
                    {x:4,y:3,z:3},{x:5,y:3,z:3},{x:6,y:3,z:3},{x:7,y:3,z:3},{x:8,y:3,z:3},{x:9,y:3,z:3},
                    {x:4,y:4,z:3},{x:5,y:4,z:3},{x:6,y:4,z:3},{x:7,y:4,z:3},{x:8,y:4,z:3},{x:9,y:4,z:3},
                    {x:5,y:5,z:3},{x:6,y:5,z:3},{x:7,y:5,z:3},{x:8,y:5,z:3},
                    // Layer 4 - Peak
                    {x:5,y:3,z:4},{x:6,y:3,z:4},{x:7,y:3,z:4},{x:8,y:3,z:4},
                    {x:5,y:4,z:4},{x:6,y:4,z:4},{x:7,y:4,z:4},{x:8,y:4,z:4}
                ];
            };

            const generateTiles = (lvl) => {
                const layout = getLayout(lvl);
                const tileSet = getTileSets(lvl);
                const tiles = [];
                const pairsNeeded = Math.ceil(layout.length / 2);
                for (let i = 0; i < pairsNeeded; i++) {
                    const type = tileSet[i % tileSet.length];
                    tiles.push(type, type);
                }
                const shuffled = tiles.sort(() => Math.random() - 0.5);
                return layout.map((pos, idx) => ({ 
                    id: idx, 
                    type: shuffled[idx], 
                    x: pos.x, 
                    y: pos.y, 
                    z: pos.z, 
                    matched: false 
                }));
            };

            const isTileBlocked = (tile, allTiles) => {
                const hasTileOnTop = allTiles.some(t => {
                    if (t.matched || t.z <= tile.z) return false;
                    const overlapX = !(t.x > tile.x + 0.5 || t.x < tile.x - 0.5);
                    const overlapY = !(t.y > tile.y + 0.5 || t.y < tile.y - 0.5);
                    return overlapX && overlapY;
                });
                if (hasTileOnTop) return true;
                const leftBlocked = allTiles.some(t => 
                    !t.matched && t.z === tile.z && t.y === tile.y && t.x === tile.x - 1
                );
                const rightBlocked = allTiles.some(t => 
                    !t.matched && t.z === tile.z && t.y === tile.y && t.x === tile.x + 1
                );
                return leftBlocked && rightBlocked;
            };

            const getTileRemovalStack = (clickedTile, allTiles) => {
                const toRemove = [clickedTile.id];
                for (let z = clickedTile.z - 1; z >= 0; z--) {
                    const tileBelow = allTiles.find(t => 
                        !t.matched && t.x === clickedTile.x && t.y === clickedTile.y && t.z === z
                    );
                    if (tileBelow) toRemove.push(tileBelow.id);
                }
                return toRemove;
            };

            const watchAdForRemoval = () => {
                if (adRemovalCooldown > 0) {
                    setHint(`Wait ${adRemovalCooldown}s`);
                    setTimeout(() => setHint(''), 2000);
                    return;
                }
                if (adRemovalsUsed >= maxAdRemovalsPerLevel) {
                    setHint(`Max ${maxAdRemovalsPerLevel} per level`);
                    setTimeout(() => setHint(''), 2000);
                    return;
                }
                setAdPurpose('tileRemoval');
                setAdCountdown(5);
                setShowAd(true);
            };
            
            const watchAdForCoins = () => {
                if (adForCoinsUsed) {
                    setHint('Already used!');
                    setTimeout(() => setHint(''), 2000);
                    return;
                }
                setAdPurpose('earnCoins');
                setAdCountdown(5);
                setShowAd(true);
            };

            const closeAdAndActivateRemoval = () => {
                setShowAd(false);
                if (adPurpose === 'tileRemoval') {
                    setIsRemovalMode(true);
                    setAdRemovalsUsed(prev => prev + 1);
                    setAdRemovalCooldown(30);
                    setHint('Click tile to remove!');
                } else if (adPurpose === 'earnCoins') {
                    const newBalance = mmlxBalance + mmlxPerAd;
                    setMmlxBalance(newBalance);
                    setAdForCoinsUsed(true);
                    if (user && !isAdmin) {
                        const users = JSON.parse(localStorage.getItem('mahjongUsers') || '{}');
                        saveUserData(user.username, {
                            ...users[user.username],
                            mmlxBalance: newBalance
                        });
                    }
                    setHint(`Earned ${mmlxPerAd} MMLX!`);
                    setTimeout(() => setHint(''), 3000);
                } else if (adPurpose === 'levelComplete') {
                    setLevel(prev => prev + 1);
                    setGameState('menu');
                }
            };

            const handleRemovalClick = (tile) => {
                if (!isRemovalMode) return;
                const toRemove = getTileRemovalStack(tile, tiles);
                setTiles(prev => {
                    const newTiles = prev.map(t => 
                        toRemove.includes(t.id) ? {...t, matched: true} : t
                    );
                    setTimeout(() => {
                        const allMatched = newTiles.every(t => t.matched);
                        if (allMatched) completeLevel();
                    }, 500);
                    return newTiles;
                });
                setIsRemovalMode(false);
                setRemovalPreview([]);
                setHint(`Removed ${toRemove.length} tile(s)!`);
                setTimeout(() => setHint(''), 2000);
            };

            const handleRemovalHover = (tile) => {
                if (!isRemovalMode) return;
                setRemovalPreview(getTileRemovalStack(tile, tiles));
            };

            useEffect(() => {
                if (adRemovalCooldown > 0) {
                    const timer = setTimeout(() => setAdRemovalCooldown(prev => prev - 1), 1000);
                    return () => clearTimeout(timer);
                }
            }, [adRemovalCooldown]);
            
            useEffect(() => {
                if (showAd && adCountdown > 0) {
                    const timer = setTimeout(() => setAdCountdown(prev => prev - 1), 1000);
                    return () => clearTimeout(timer);
                }
            }, [showAd, adCountdown]);

            const startLevel = () => {
                if (isAdmin) return;
                setTiles(generateTiles(level));
                setSelectedTiles([]);
                setStartTime(Date.now());
                setElapsedTime(0);
                setHint('');
                setAdRemovalsUsed(0);
                setAdRemovalCooldown(0);
                setIsRemovalMode(false);
                setRemovalPreview([]);
                setAdForCoinsUsed(false);
                setGameState('playing');
            };

            useEffect(() => {
                if (gameState === 'playing' && startTime) {
                    const timer = setInterval(() => 
                        setElapsedTime(Math.floor((Date.now() - startTime) / 1000)), 1000
                    );
                    return () => clearInterval(timer);
                }
            }, [gameState, startTime]);

            const selectTile = (tile) => {
                if (isRemovalMode) {
                    handleRemovalClick(tile);
                    return;
                }
                if (tile.matched || isTileBlocked(tile, tiles)) {
                    setHint('Blocked!');
                    setTimeout(() => setHint(''), 2000);
                    return;
                }
                if (selectedTiles.find(t => t.id === tile.id)) {
                    setSelectedTiles(selectedTiles.filter(t => t.id !== tile.id));
                    return;
                }
                const newSelected = [...selectedTiles, tile];
                setSelectedTiles(newSelected);
                if (newSelected.length === 2) {
                    if (newSelected[0].type === newSelected[1].type) {
                        setTimeout(() => {
                            setTiles(prev => prev.map(t => 
                                t.id === newSelected[0].id || t.id === newSelected[1].id 
                                    ? { ...t, matched: true } 
                                    : t
                            ));
                            setSelectedTiles([]);
                            const allMatched = tiles.every(t => 
                                t.matched || t.id === newSelected[0].id || t.id === newSelected[1].id
                            );
                            if (allMatched) completeLevel();
                        }, 300);
                    } else {
                        setHint('No match!');
                        setTimeout(() => { setSelectedTiles([]); setHint(''); }, 1000);
                    }
                }
            };

            const completeLevel = () => {
                const timeTaken = elapsedTime;
                const timeBonus = Math.max(0, averageTime - timeTaken);
                const baseReward = 1000 + (level * 100);
                const bonusReward = Math.floor((timeBonus / averageTime) * (2000 + level * 200));
                const totalReward = baseReward + bonusReward;
                const newBalance = mmlxBalance + totalReward;
                setMmlxBalance(newBalance);
                setCompletedLevels(prev => prev + 1);
                
                if (user && !isAdmin) {
                    saveUserData(user.username, {
                        password: JSON.parse(localStorage.getItem('mahjongUsers') || '{}')[user.username].password,
                        mmlxBalance: newBalance, 
                        level: level + 1, 
                        completedLevels: completedLevels + 1,
                        mlxAddress: mlxAddress,
                        tangledUsername: tangledUsername
                    });
                }
                
                alert(`Level Complete!\n\nTime: ${timeTaken}s\nBase: ${baseReward.toLocaleString()} MMLX\nBonus: ${bonusReward.toLocaleString()} MMLX\nTotal: ${totalReward.toLocaleString()} MMLX`);
                
                if (adsEnabled && level % adFrequency === 0) {
                    setAdPurpose('levelComplete');
                    setAdCountdown(5);
                    setShowAd(true);
                } else {
                    setLevel(prev => prev + 1);
                    setGameState('menu');
                }
            };

            const handleAuth = () => {
                if (!username || !password) { 
                    alert('Enter username and password'); 
                    return; 
                }
                if (username === ADMIN_USERNAME && btoa(password) === ADMIN_PASSWORD_HASH) {
                    setUser({ username: ADMIN_USERNAME });
                    setIsAdmin(true);
                    setGameState('menu');
                    return;
                }
                
                const users = JSON.parse(localStorage.getItem('mahjongUsers') || '{}');
                
                if (isLogin) {
                    if (users[username] && users[username].password === password) {
                        // Verify data integrity
                        if (!verifyUserData(username)) return;
                        
                        setUser({ username });
                        setMmlxBalance(users[username].mmlxBalance || 0);
                        setLevel(users[username].level || 1);
                        setCompletedLevels(users[username].completedLevels || 0);
                        setMlxAddress(users[username].mlxAddress || '');
                        setTangledUsername(users[username].tangledUsername || '');
                        setGameState('menu');
                    } else {
                        alert('Invalid credentials');
                    }
                } else {
                    if (users[username]) {
                        alert('Username exists');
                    } else {
                        saveUserData(username, {
                            password, 
                            mmlxBalance: 0, 
                            level: 1, 
                            completedLevels: 0, 
                            mlxAddress: '', 
                            tangledUsername: ''
                        });
                        setUser({ username });
                        setMmlxBalance(0);
                        setLevel(1);
                        setGameState('menu');
                    }
                }
            };

            if (showAd) {
                return (
                    <div className="min-h-screen bg-black bg-opacity-95 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">Advertisement</h2>
                            
                            <div className="bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl p-8 mb-4 min-h-[300px] flex flex-col items-center justify-center text-white shadow-2xl">
                                <div className="text-6xl mb-2">ðŸŽ®</div>
                                <p className="text-3xl font-bold mb-2">Play & Win!</p>
                                <p className="text-lg">Join 10M+ Players</p>
                            </div>
                            
                            {adCountdown > 0 && (
                                <div className="bg-gray-100 rounded-lg p-3 mb-4">
                                    <p className="text-sm text-gray-600">
                                        Wait <span className="font-bold text-purple-600">{adCountdown}</span> seconds...
                                    </p>
                                </div>
                            )}
                            
                            <button 
                                onClick={closeAdAndActivateRemoval} 
                                disabled={adCountdown > 0}
                                className={`font-bold py-3 px-8 rounded-lg ${
                                    adCountdown > 0 
                                    ? 'bg-gray-300 text-gray-500' 
                                    : 'bg-gradient-to-r from-purple-500 to-blue-500 text-white'
                                }`}
                            >
                                {adCountdown > 0 ? `Wait ${adCountdown}s` : 
                                 adPurpose === 'tileRemoval' ? 'Activate Removal' : 
                                 adPurpose === 'earnCoins' ? `Claim ${mmlxPerAd} MMLX` : 
                                 'Continue'}
                            </button>
                        </div>
                    </div>
                );
            }

            if (gameState === 'login') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                            <h1 className="text-4xl font-bold text-purple-600 mb-2 text-center">Mahjong MLX</h1>
                            <p className="text-gray-600 text-center mb-8">Play & Earn Crypto</p>
                            
                            {/* Tangled.com Join Prompt */}
                            <div className="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300 rounded-xl p-4 mb-6">
                                <p className="text-sm font-bold text-green-800 mb-2">Get Paid in MLX</p>
                                <p className="text-xs text-gray-700 mb-3">Join Tangled.com to receive your cryptocurrency rewards!</p>
                                <a 
                                    href="https://alexisread.tangled.com/join?l=en&s1=majong" 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="block w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-2 px-4 rounded-lg text-center hover:shadow-lg transition-all"
                                >
                                    Join Tangled.com FREE
                                </a>
                            </div>
                            
                            <div className="space-y-4">
                                <input 
                                    type="text" 
                                    placeholder="Username" 
                                    value={username} 
                                    onChange={(e) => setUsername(e.target.value)} 
                                    className="w-full border-2 rounded-lg px-4 py-3" 
                                />
                                <input 
                                    type="password" 
                                    placeholder="Password" 
                                    value={password} 
                                    onChange={(e) => setPassword(e.target.value)} 
                                    className="w-full border-2 rounded-lg px-4 py-3" 
                                />
                                <button 
                                    onClick={handleAuth} 
                                    className="w-full bg-gradient-to-r from-purple-500 to-blue-500 text-white font-bold py-3 rounded-lg"
                                >
                                    {isLogin ? 'Login' : 'Register'}
                                </button>
                                <button 
                                    onClick={() => setIsLogin(!isLogin)} 
                                    className="w-full text-purple-600 text-sm"
                                >
                                    {isLogin ? "Register" : 'Login'}
                                </button>
                                <p className="text-xs text-center text-gray-500">Admin: admin / MahjongMLX2025!</p>
                            </div>
                        </div>
                    </div>
                );
            }

            if (gameState === 'menu') {
                // Show Tangled prompt after first level if no payment info
                const shouldShowTangledPrompt = completedLevels > 0 && !tangledUsername && !mlxAddress && !showTangledPrompt;
                
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 p-4">
                        <div className="max-w-md mx-auto">
                            {/* Tangled.com Prompt (after first level) */}
                            {shouldShowTangledPrompt && (
                                <div className="bg-white rounded-2xl shadow-lg p-6 mb-4 border-4 border-green-400">
                                    <div className="text-center mb-4">
                                        <p className="text-2xl font-bold text-green-600 mb-2">Ready to Get Paid?</p>
                                        <p className="text-gray-700 text-sm mb-1">You're earning MMLX tokens!</p>
                                        <p className="text-gray-700 text-sm mb-4">Join Tangled.com to exchange them for real MLX cryptocurrency.</p>
                                    </div>
                                    
                                    <a 
                                        href="https://alexisread.tangled.com/join?l=en&s1=majong" 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        className="block w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-3 px-4 rounded-lg text-center hover:shadow-lg transition-all mb-3"
                                    >
                                        Join Tangled.com FREE
                                    </a>
                                    
                                    <button 
                                        onClick={() => setShowTangledPrompt(true)}
                                        className="w-full text-gray-500 text-sm hover:text-gray-700"
                                    >
                                        Maybe later
                                    </button>
                                </div>
                            )}
                            
                            <div className="bg-white rounded-2xl shadow-lg p-6 mb-4">
                                {/* Join Tangled Button - Always visible */}
                                <a 
                                    href="https://alexisread.tangled.com/join?l=en&s1=majong" 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="block w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-3 px-4 rounded-xl text-center hover:shadow-lg transition-all mb-4"
                                >
                                    JOIN TANGLED TO GET PAID
                                </a>
                                
                                <div className="flex items-center justify-between mb-4">
                                    <div>
                                        <p className="text-sm text-gray-600">Welcome</p>
                                        <p className="font-bold text-lg">{user?.username}</p>
                                    </div>
                                    <button 
                                        onClick={() => { 
                                            setUser(null); 
                                            setIsAdmin(false); 
                                            setGameState('login'); 
                                        }} 
                                        className="text-gray-400"
                                    >
                                        Logout
                                    </button>
                                </div>
                                <div className="grid grid-cols-3 gap-4 text-center">
                                    <div className="bg-purple-50 rounded-lg p-3">
                                        <p className="text-2xl font-bold text-purple-600">{mmlxBalance.toLocaleString()}</p>
                                        <p className="text-xs text-gray-600">MMLX</p>
                                    </div>
                                    <div className="bg-blue-50 rounded-lg p-3">
                                        <p className="text-2xl font-bold text-blue-600">{level}</p>
                                        <p className="text-xs text-gray-600">Level</p>
                                    </div>
                                    <div className="bg-green-50 rounded-lg p-3">
                                        <p className="text-2xl font-bold text-green-600">{completedLevels}</p>
                                        <p className="text-xs text-gray-600">Done</p>
                                    </div>
                                </div>
                            </div>
                            <button 
                                onClick={startLevel} 
                                disabled={isAdmin} 
                                className="w-full bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-2xl shadow-lg p-6 mb-4 disabled:opacity-50"
                            >
                                <p className="text-2xl font-bold">Play Level {level}</p>
                                <p className="text-sm mt-1">Earn {(1000 + level * 100).toLocaleString()}+ MMLX</p>
                            </button>
                            <div className="grid grid-cols-2 gap-4">
                                <button 
                                    onClick={() => setGameState('wallet')} 
                                    className="bg-white rounded-xl shadow p-4"
                                >
                                    Exchange
                                </button>
                                <button 
                                    onClick={() => setGameState('settings')} 
                                    className="bg-white rounded-xl shadow p-4"
                                >
                                    Settings
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (gameState === 'playing') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-amber-100 to-amber-200 p-2">
                        <div className="max-w-4xl mx-auto">
                            <div className="bg-white rounded-xl shadow p-3 mb-3 flex justify-between items-center flex-wrap gap-2">
                                <div className="flex gap-3 items-center">
                                    <span className="font-bold">{elapsedTime}s</span>
                                    <span className="text-purple-600">{tiles.filter(t => !t.matched).length} tiles</span>
                                </div>
                                
                                <div className="flex gap-2">
                                    <button 
                                        onClick={watchAdForCoins}
                                        disabled={adForCoinsUsed}
                                        className={`px-4 py-2 rounded-lg font-bold text-white text-sm ${
                                            adForCoinsUsed ? 'bg-gray-400' : 'bg-green-500'
                                        }`}
                                    >
                                        {adForCoinsUsed ? 'Used' : `+${mmlxPerAd}`}
                                    </button>
                                    
                                    <button 
                                        onClick={watchAdForRemoval}
                                        disabled={adRemovalCooldown > 0 || adRemovalsUsed >= maxAdRemovalsPerLevel}
                                        className={`px-4 py-2 rounded-lg font-bold text-white text-sm ${
                                            isRemovalMode ? 'bg-red-500' :
                                            adRemovalCooldown > 0 || adRemovalsUsed >= maxAdRemovalsPerLevel ? 'bg-gray-400' : 
                                            'bg-orange-500'
                                        }`}
                                    >
                                        {isRemovalMode ? 'SELECT' :
                                         adRemovalCooldown > 0 ? `${adRemovalCooldown}s` :
                                         `Remove (${adRemovalsUsed}/${maxAdRemovalsPerLevel})`}
                                    </button>
                                </div>
                                
                                <button onClick={() => setGameState('menu')} className="bg-red-500 text-white px-3 py-1 rounded">
                                    Quit
                                </button>
                            </div>
                            
                            {hint && (
                                <div className="bg-yellow-100 rounded-xl p-3 mb-3 text-center">
                                    <p className="font-bold text-yellow-700">{hint}</p>
                                </div>
                            )}
                            
                            <div className="bg-gradient-to-br from-amber-700 to-amber-900 rounded-xl p-4 flex items-center justify-center" style={{minHeight:'400px'}}>
                                <div style={{position:'relative',width:'650px',height:'450px'}}>
                                    {tiles.map(tile => {
                                        const blocked = isTileBlocked(tile, tiles);
                                        const selected = selectedTiles.find(t => t.id === tile.id);
                                        const willBeRemoved = removalPreview.includes(tile.id);
                                        return (
                                            <div 
                                                key={tile.id} 
                                                className={`tile-3d ${tile.matched?'tile-matched':''} ${blocked && !isRemovalMode?'tile-blocked':''} ${isRemovalMode ? 'tile-removal-mode' : ''}`} 
                                                style={{
                                                    left:`${tile.x*45+tile.z*2}px`,
                                                    top:`${tile.y*45+tile.z*2}px`,
                                                    zIndex:tile.z*100+tile.y*10+tile.x,
                                                    width:'45px',
                                                    height:'45px'
                                                }} 
                                                onClick={() => !tile.matched && selectTile(tile)}
                                                onMouseEnter={() => !tile.matched && isRemovalMode && handleRemovalHover(tile)}
                                                onMouseLeave={() => setRemovalPreview([])}
                                            >
                                                <div 
                                                    className={`tile-face ${selected?'tile-selected':''} ${willBeRemoved?'tile-will-remove':''}`} 
                                                    style={{width:'100%',height:'100%',fontSize:'1.75rem'}}
                                                >
                                                    {tile.type}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (gameState === 'wallet') {
                const handleExchange = async () => {
                    if (mmlxBalance < 10000) {
                        alert('Minimum: 10,000 MMLX');
                        return;
                    }
                    if (!mlxAddress && !tangledUsername) {
                        alert('Add payment info in Settings first!');
                        setGameState('settings');
                        return;
                    }
                    
                    // Check exchange limit (1 per 24 hours)
                    const exchangeCheck = canUserExchange(user.username);
                    if (!exchangeCheck.allowed) {
                        alert(`â³ Exchange Limit Reached\n\nYou can only exchange once per 24 hours.\n\nNext exchange available in ${exchangeCheck.hoursRemaining} hours.`);
                        return;
                    }
                    
                    // Verify data integrity before exchange
                    if (!verifyUserData(user.username)) {
                        alert('Data verification failed. Cannot process exchange.');
                        return;
                    }
                    
                    const mlxAmount = (mmlxBalance / exchangeRate).toFixed(6);
                    const exchangeData = {
                        username: user.username,
                        mmlxAmount: mmlxBalance,
                        mlxAmount: mlxAmount,
                        mlxAddress: mlxAddress,
                        tangledUsername: tangledUsername,
                        timestamp: new Date().toISOString(),
                        date: new Date().toLocaleString(),
                        userChecksum: JSON.parse(localStorage.getItem('mahjongUsers') || '{}')[user.username]?.checksum
                    };
                    
                    // Save to localStorage
                    const exchanges = JSON.parse(localStorage.getItem('exchangeRequests') || '[]');
                    exchanges.push(exchangeData);
                    localStorage.setItem('exchangeRequests', JSON.stringify(exchanges));
                    
                    // Deduct MMLX
                    const newBalance = 0;
                    setMmlxBalance(newBalance);
                    if (user) {
                        const users = JSON.parse(localStorage.getItem('mahjongUsers') || '{}');
                        saveUserData(user.username, {
                            ...users[user.username],
                            mmlxBalance: newBalance
                        });
                    }
                    
                    // Send email notification via EmailJS
                    if (EMAILJS_SERVICE_ID !== 'YOUR_SERVICE_ID') {
                        try {
                            await emailjs.send(
                                EMAILJS_SERVICE_ID,
                                EMAILJS_TEMPLATE_ID,
                                {
                                    username: exchangeData.username,
                                    mmlx_amount: parseInt(exchangeData.mmlxAmount).toLocaleString(),
                                    mlx_amount: exchangeData.mlxAmount,
                                    tangled_username: exchangeData.tangledUsername || 'Not provided',
                                    mlx_address: exchangeData.mlxAddress || 'Not provided',
                                    date: exchangeData.date
                                },
                                EMAILJS_PUBLIC_KEY
                            );
                            console.log('Email sent successfully to admin!');
                        } catch (error) {
                            console.error('Email failed:', error);
                            alert('Exchange submitted but email notification failed. Contact admin directly.');
                        }
                    } else {
                        console.log('EmailJS not configured. Exchange saved to localStorage only.');
                    }
                    
                    alert(`Exchange Submitted!\n\n${parseInt(exchangeData.mmlxAmount).toLocaleString()} MMLX = ${mlxAmount} MLX\n\nYou'll receive MLX within 24 hours.\n\nNext exchange available in 24 hours.`);
                    
                    setGameState('menu');
                };
                
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 p-4">
                        <div className="max-w-md mx-auto">
                            <button onClick={() => setGameState('menu')} className="text-white mb-4">Back</button>
                            <div className="bg-white rounded-2xl p-6">
                                <h2 className="text-2xl font-bold text-purple-600 mb-4">Exchange</h2>
                                
                                <div className="bg-yellow-100 rounded-xl p-4 mb-4">
                                    <p className="text-3xl font-bold text-yellow-700">{mmlxBalance.toLocaleString()} MMLX</p>
                                    <p className="text-gray-700 text-lg mt-1">= {(mmlxBalance/exchangeRate).toFixed(6)} MLX</p>
                                </div>
                                
                                {(!mlxAddress && !tangledUsername) && (
                                    <div className="bg-orange-50 border-2 border-orange-300 rounded-lg p-4 mb-4">
                                        <p className="text-orange-800 font-bold mb-2">Action Required</p>
                                        <p className="text-sm text-orange-700">Add payment info in Settings!</p>
                                        <button 
                                            onClick={() => setGameState('settings')} 
                                            className="mt-2 bg-orange-500 text-white px-4 py-2 rounded-lg text-sm font-bold"
                                        >
                                            Go to Settings
                                        </button>
                                    </div>
                                )}
                                
                                <button 
                                    onClick={handleExchange} 
                                    disabled={mmlxBalance < 10000}
                                    className={`w-full py-3 rounded-xl font-bold text-white ${
                                        mmlxBalance >= 10000 ? 'bg-green-500' : 'bg-gray-400'
                                    }`}
                                >
                                    {mmlxBalance >= 10000 ? 'Submit Exchange' : 'Need 10,000 MMLX'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (gameState === 'settings') {
                const savePaymentInfo = () => {
                    if (user && !isAdmin) {
                        const users = JSON.parse(localStorage.getItem('mahjongUsers') || '{}');
                        saveUserData(user.username, {
                            ...users[user.username],
                            mlxAddress, 
                            tangledUsername 
                        });
                        setHint('Saved!');
                        setTimeout(() => setHint(''), 2000);
                    }
                };
                
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-600 p-4">
                        <div className="max-w-md mx-auto">
                            <button onClick={() => setGameState('menu')} className="text-white mb-4">Back</button>
                            <div className="bg-white rounded-2xl p-6 max-h-[calc(100vh-100px)] overflow-y-auto">
                                <h2 className="text-2xl font-bold text-purple-600 mb-4">
                                    {isAdmin ? 'Admin Settings' : 'Settings'}
                                </h2>
                                
                                {!isAdmin && (
                                    <>
                                        <div className="border-2 border-blue-300 rounded-lg p-4 bg-blue-50">
                                            <label className="block mb-2 text-sm font-bold">Tangled.com Username</label>
                                            <input 
                                                type="text" 
                                                value={tangledUsername} 
                                                onChange={(e)=>setTangledUsername(e.target.value)}
                                                placeholder="username"
                                                className="w-full border-2 rounded-lg px-4 py-2 mb-3" 
                                            />
                                            
                                            <label className="block mb-2 text-sm font-bold">OR MLX Address</label>
                                            <input 
                                                type="text" 
                                                value={mlxAddress} 
                                                onChange={(e)=>setMlxAddress(e.target.value)}
                                                placeholder="MLX1..."
                                                className="w-full border-2 rounded-lg px-4 py-2 mb-3" 
                                            />
                                            
                                            <button 
                                                onClick={savePaymentInfo}
                                                className="w-full bg-blue-600 text-white py-2 rounded-lg font-bold"
                                            >
                                                Save Payment Info
                                            </button>
                                        </div>
                                        <div className="bg-gray-50 rounded-lg p-4 text-center mt-4">
                                            <p className="text-sm text-gray-600">Game settings managed by admin</p>
                                        </div>
                                    </>
                                )}
                                
                                {isAdmin && (
                                    <>
                                        <div className="bg-red-50 rounded-lg p-3 mb-4">
                                            <p className="text-red-700 font-bold">Admin Mode</p>
                                        </div>
                                        
                                        <div className="mb-4 border-2 border-yellow-400 rounded-lg p-4 bg-yellow-50">
                                            <label className="block mb-2 text-sm font-bold text-yellow-700">EmailJS Configuration</label>
                                            <p className="text-xs text-gray-600 mb-3">
                                                Get your credentials from emailjs.com â†’ Email Services & Templates
                                            </p>
                                            
                                            <label className="block mb-1 text-xs font-semibold">Service ID</label>
                                            <p className="text-xs bg-white p-2 rounded border mb-2 font-mono">{EMAILJS_SERVICE_ID}</p>
                                            
                                            <label className="block mb-1 text-xs font-semibold">Template ID</label>
                                            <p className="text-xs bg-white p-2 rounded border mb-2 font-mono">{EMAILJS_TEMPLATE_ID}</p>
                                            
                                            <label className="block mb-1 text-xs font-semibold">Public Key</label>
                                            <p className="text-xs bg-white p-2 rounded border mb-2 font-mono">{EMAILJS_PUBLIC_KEY}</p>
                                            
                                            <div className={`mt-2 p-2 rounded text-xs ${EMAILJS_SERVICE_ID === 'YOUR_SERVICE_ID' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                                {EMAILJS_SERVICE_ID === 'YOUR_SERVICE_ID' 
                                                    ? 'âŒ Not configured - Edit HTML file to add your EmailJS credentials' 
                                                    : 'âœ… Configured - You will receive email notifications'}
                                            </div>
                                        </div>
                                        
                                        <label className="block mb-2 text-sm font-bold">Exchange Rate</label>
                                        <input 
                                            type="number" 
                                            value={exchangeRate} 
                                            onChange={(e)=>setExchangeRate(Math.max(1, parseInt(e.target.value)||100000))} 
                                            className="w-full border-2 rounded-lg px-4 py-2 mb-4" 
                                        />
                                        
                                        <label className="block mb-2 text-sm font-bold">MMLX Per Ad</label>
                                        <input 
                                            type="number" 
                                            value={mmlxPerAd} 
                                            onChange={(e)=>setMmlxPerAd(Math.max(1, parseInt(e.target.value)||500))} 
                                            className="w-full border-2 rounded-lg px-4 py-2 mb-4" 
                                        />
                                        
                                        <label className="block mb-2 text-sm font-bold">Tile Removals Per Level</label>
                                        <input 
                                            type="number" 
                                            value={maxAdRemovalsPerLevel} 
                                            onChange={(e)=>setMaxAdRemovalsPerLevel(Math.max(1, parseInt(e.target.value)||2))} 
                                            className="w-full border-2 rounded-lg px-4 py-2 mb-4" 
                                        />
                                        
                                        <div className="border-t-2 pt-4 mb-4">
                                            <label className="flex items-center justify-between mb-3">
                                                <span className="text-sm font-bold">Enable Interstitial Ads</span>
                                                <input 
                                                    type="checkbox" 
                                                    checked={adsEnabled} 
                                                    onChange={(e)=>setAdsEnabled(e.target.checked)} 
                                                    className="w-6 h-6" 
                                                />
                                            </label>
                                            
                                            <label className="block mb-2 text-sm font-bold">Ad Every X Levels</label>
                                            <input 
                                                type="number" 
                                                value={adFrequency} 
                                                onChange={(e)=>setAdFrequency(Math.max(1, parseInt(e.target.value)||3))} 
                                                className="w-full border-2 rounded-lg px-4 py-2" 
                                            />
                                            <p className="text-xs text-gray-600 mt-1">
                                                Ad shows at: {adFrequency}, {adFrequency*2}, {adFrequency*3}...
                                            </p>
                                        </div>
                                        
                                        <div className="border-t-2 pt-4 bg-red-50 rounded-lg p-4">
                                            <button 
                                                onClick={() => {
                                                    const exchanges = JSON.parse(localStorage.getItem('exchangeRequests') || '[]');
                                                    if (exchanges.length === 0) {
                                                        alert('No requests');
                                                    } else {
                                                        let msg = `EXCHANGES (${exchanges.length}):\n\n`;
                                                        exchanges.forEach((ex, i) => {
                                                            msg += `${i+1}. ${ex.username}\n`;
                                                            msg += `   ${parseInt(ex.mmlxAmount).toLocaleString()} MMLX\n`;
                                                            msg += `   Tangled: ${ex.tangledUsername || 'N/A'}\n`;
                                                            msg += `   Address: ${ex.mlxAddress || 'N/A'}\n\n`;
                                                        });
                                                        alert(msg);
                                                    }
                                                }}
                                                className="w-full bg-red-600 text-white py-2 rounded-lg font-bold mb-2"
                                            >
                                                View Exchanges
                                            </button>
                                            <button 
                                                onClick={() => {
                                                    if (confirm('Clear all logs?')) {
                                                        localStorage.setItem('exchangeRequests', '[]');
                                                        alert('Cleared');
                                                    }
                                                }}
                                                className="w-full bg-gray-600 text-white py-2 rounded-lg font-bold"
                                            >
                                                Clear Logs
                                            </button>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        };

        ReactDOM.render(<MahjongMLX />, document.getElementById('root'));
    </script>
</body>

</html>
